---
/**
 * CookieConsent.astro
 * Banner simples de consentimento (fallback fora da UE), compatível com a CMP do Google (Funding Choices).
 * - Grava em localStorage: cookie_consent = "granted" | "denied"
 * - Só chama window.enableAnalyticsAndAds() quando a CMP NÃO estiver ativa.
 * - Se a CMP estiver ativa (iframe "googlefcPresent"), este banner não aparece.
 */
---

<style>
  #cookie-banner {
    position: fixed;
    inset-block-end: 0; /* bottom */
    inset-inline: 0;    /* left/right */
    z-index: 9999;
    background: rgba(17, 24, 39, 0.95); /* gray-900 */
    color: white;
    font-size: 0.9rem;
    backdrop-filter: saturate(150%) blur(4px);
    transform: translateY(100%);
    animation: cr-slide-in 320ms ease forwards;
  }
  @keyframes cr-slide-in { to { transform: translateY(0); } }

  #cookie-banner .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0.9rem 1rem;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.75rem;
    align-items: center;
  }
  @media (max-width: 640px) {
    #cookie-banner .wrap { grid-template-columns: 1fr; }
  }

  #cookie-banner a { text-decoration: underline; }
  #cookie-banner .btn {
    appearance: none;
    border: 1px solid rgba(255,255,255,.18);
    border-radius: 0.6rem;
    padding: 0.5rem 0.9rem;
    cursor: pointer;
    background: transparent;
    color: white;
  }
  #cookie-banner .btn-accept {
    background: #2563eb; /* azul do site */
    border-color: #2563eb;
  }
  #cookie-banner .btn:hover { filter: brightness(1.05); }
</style>

<div id="cookie-banner" role="region" aria-label="Consentimento de cookies" hidden>
  <div class="wrap">
    <div>
      Usamos cookies para analisar o tráfego (GA4) e exibir anúncios (AdSense).
      Você pode aceitar ou recusar. Leia a nossa
      <a href="/politica-privacidade/">Política de Privacidade</a>.
    </div>
    <div class="flex gap-2 justify-end">
      <button class="btn" id="cr-decline" type="button">Recusar</button>
      <button class="btn btn-accept" id="cr-accept" type="button">Aceitar</button>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    var KEY = 'cookie_consent';

    function isCmpActive() {
      // Funding Choices injeta um iframe "googlefcPresent" quando a CMP está ativa
      try {
        if (window.frames && window.frames['googlefcPresent']) return true;
        if (document.querySelector('iframe[name="googlefcPresent"]')) return true;
      } catch (_) {}
      return false;
    }

    function init() {
      try {
        var banner    = document.getElementById('cookie-banner');
        var acceptBtn = document.getElementById('cr-accept');
        var declineBtn= document.getElementById('cr-decline');
        var saved     = localStorage.getItem(KEY);
        var cmpAtiva  = isCmpActive();

        // Se a CMP do Google estiver ativa, não mostramos o banner custom (ela cuida da UE/UK/CH)
        if (cmpAtiva) {
          if (banner) banner.remove();
          return;
        }

        // Fora da UE (sem CMP): respeita escolhas salvas localmente
        if (saved === 'granted') {
          if (banner) banner.remove();
          // Ativa GA4/Ads somente quando NÃO há CMP
          if (typeof window.enableAnalyticsAndAds === 'function') {
            window.enableAnalyticsAndAds();
          }
          return;
        }
        if (saved === 'denied') {
          if (banner) banner.remove(); // mantém default "denied" do Consent Mode no <head>
          return;
        }

        // Sem escolha e sem CMP: mostra o banner
        banner.hidden = false;

        acceptBtn.addEventListener('click', function () {
          localStorage.setItem(KEY, 'granted');
          if (typeof window.enableAnalyticsAndAds === 'function') {
            window.enableAnalyticsAndAds();
          }
          banner.remove();
        });

        declineBtn.addEventListener('click', function () {
          localStorage.setItem(KEY, 'denied');
          banner.remove();
        });
      } catch (e) {
        // Em caso de bloqueio à storage, pelo menos garante que o banner apareça
        var b = document.getElementById('cookie-banner');
        if (b && !isCmpActive()) b.hidden = false;
      }
    }

    // Funding Choices pode criar o iframe um pouco depois do DOM carregar.
    // Pequeno atraso garante detecção consistente da CMP:
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function(){ setTimeout(init, 50); });
    } else {
      setTimeout(init, 50);
    }
  })();
</script>